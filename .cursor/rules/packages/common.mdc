# @dukkani/common Package

## Purpose

The `common` package contains shared business logic, entities, schemas, services, and utilities used across the monorepo. It's the core domain layer of the application.

## Structure

```
packages/common/src/
├── entities/          # Database entity transformations
│   └── {entity-name}/
│       ├── entity.ts  # Transformation logic (getSimpleRo, getRo)
│       ├── query.ts    # Prisma query builders
│       └── index.ts    # Exports
├── schemas/           # Zod validation schemas
│   └── {entity-name}/
│       ├── input.ts   # Input validation schemas
│       ├── output.ts  # Output type schemas
│       ├── enums.ts   # Enum schemas
│       └── index.ts   # Exports
├── services/          # Business logic layer
│   └── {entity}-service.ts
├── utils/             # Shared utilities
│   └── {utility-name}.ts
└── index.ts           # Package exports
```

## Entities

### Location
`packages/common/src/entities/{entity-name}/`

### Pattern

Each entity has three files:

1. **entity.ts** - Transforms database data to output schemas
   - `getSimpleRo()` - Transforms simple database data (no relations)
   - `getRo()` - Transforms database data with relations

2. **query.ts** - Builds Prisma queries
   - `getSimpleInclude()` - No relations
   - `getInclude()` - All relations
   - `getClientSafeInclude()` - Relations safe for client (excludes sensitive data)
   - `getWhere()` - Builds where clauses
   - `getOrder()` - Builds order by clauses

3. **index.ts** - Exports entity and query classes

### Example

```typescript
// entity.ts
export class StoreEntity {
  static getSimpleRo(entity: StoreSimpleDbData): StoreSimpleOutput {
    return {
      id: entity.id,
      name: entity.name,
      // ... map all simple fields
    };
  }

  static getRo(entity: StoreIncludeDbData): StoreIncludeOutput {
    return {
      ...this.getSimpleRo(entity),
      owner: UserEntity.getSimpleRo(entity.owner),
      products: entity.products.map(ProductEntity.getSimpleRo),
    };
  }
}
```

### Naming

- Folder: `kebab-case` (e.g., `store-plan`, `order-item`)
- Class: `PascalCase` with `Entity` or `Query` suffix
- Methods: `camelCase` (e.g., `getSimpleRo`, `getInclude`)

## Schemas

### Location
`packages/common/src/schemas/{entity-name}/`

### Pattern

Each schema has multiple files:

1. **input.ts** - Input validation schemas
   - `{entity}InputSchema` - Base input schema
   - `create{Entity}InputSchema` - Create operation schema
   - `update{Entity}InputSchema` - Update operation schema
   - `get{Entity}InputSchema` - Get by ID schema
   - `list{Entity}InputSchema` - List with pagination schema
   - Type exports using `z.infer<>`

2. **output.ts** - Output type schemas
   - `{entity}SimpleOutputSchema` - Simple output (no relations)
   - `{entity}IncludeOutputSchema` - Output with relations
   - `list{Entity}OutputSchema` - Paginated list output
   - Type exports using `z.infer<>`

3. **enums.ts** - Enum schemas using Zod
   - `{entity}{Field}Schema` - Enum schemas

4. **index.ts** - Exports all schemas

### Example

```typescript
// input.ts
export const storeInputSchema = z.object({
  name: z.string().min(1, "Store name is required"),
  slug: z.string().min(1, "Store slug is required"),
});

export const createStoreInputSchema = storeInputSchema;
export const updateStoreInputSchema = storeInputSchema.partial().extend({
  id: z.string().min(1, "Store ID is required"),
});

export type StoreInput = z.infer<typeof storeInputSchema>;
export type CreateStoreInput = z.infer<typeof createStoreInputSchema>;
```

### Naming

- Folder: `kebab-case`
- Schema variables: `camelCase` with descriptive suffix
- Types: `PascalCase` with descriptive suffix

## Services

### Location
`packages/common/src/services/`

### Pattern

Services contain business logic and database operations. They use static class methods.

### File Naming
`{entity}-service.ts` (kebab-case)

### Class Naming
`{Entity}Service` (PascalCase)

### Example

```typescript
export class StoreService {
  static async getAllStores(userId: string): Promise<StoreSimpleOutput[]> {
    const stores = await database.store.findMany({
      where: { ownerId: userId },
      include: StoreQuery.getClientSafeInclude(),
    });

    return stores.map(StoreEntity.getSimpleRo);
  }

  static async getStoreById(
    id: string,
    userId: string,
  ): Promise<StoreIncludeOutput> {
    const store = await database.store.findUnique({
      where: { id },
      include: StoreQuery.getInclude(),
    });

    if (!store) {
      throw new Error("Store not found");
    }

    if (store.ownerId !== userId) {
      throw new Error("You don't have access to this store");
    }

    return StoreEntity.getRo(store);
  }
}
```

### Best Practices

- Use transactions for operations that modify multiple records
- Always verify ownership/access before returning data
- Use entities to transform database data to output schemas
- Use queries to build Prisma includes and where clauses
- Throw descriptive errors that can be caught by routers

## Utils

### Location
`packages/common/src/utils/`

### Pattern

Utility functions are pure functions (no side effects when possible).

### File Naming
`{utility-name}.ts` (kebab-case)

### Example

```typescript
// format-currency.ts
export function formatCurrency(amount: number): string {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(amount);
}
```

## Exports

### Main Index
`packages/common/src/index.ts` exports:
- `schemas` - All schema exports
- `entities` - All entity exports
- `services` - All service exports
- `utils` - All utility exports

### Usage

```typescript
import { StoreService } from "@dukkani/common/services";
import { StoreEntity } from "@dukkani/common/entities/store";
import { storeInputSchema } from "@dukkani/common/schemas/store/input";
import { formatCurrency } from "@dukkani/common/utils";
```

## Dependencies

- `@dukkani/db` - Database client and Prisma types
- `zod` - Schema validation

## Dependents

- `@dukkani/orpc` - Uses services and schemas in routers
- `apps/dashboard` - Uses schemas for type safety
- `apps/web` - Uses schemas for type safety
